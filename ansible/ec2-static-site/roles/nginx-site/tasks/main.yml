# ============================================================================
# TASKS/MAIN.YML - Tarefas da Role nginx-site
# ============================================================================
# Este arquivo contém todas as tarefas necessárias para configurar o Nginx
# e servir um site customizado.
#
# Documentação: https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html
# ============================================================================

---
# ============================================================================
# SEÇÃO 1: ATUALIZAR SISTEMA OPERACIONAL
# ============================================================================
# Atualiza os pacotes do sistema para garantir segurança e compatibilidade
# ============================================================================

- name: Atualizar lista de pacotes
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags:
    - system
    - update

- name: Atualizar pacotes do sistema
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  tags:
    - system
    - update

# ============================================================================
# SEÇÃO 2: INSTALAR NGINX
# ============================================================================
# Instala o servidor web Nginx
# ============================================================================

- name: Instalar Nginx
  apt:
    name: nginx
    state: present
  tags:
    - nginx
    - install

- name: Iniciar serviço Nginx
  systemd:
    name: nginx
    state: started
    enabled: yes
  tags:
    - nginx
    - service

# ============================================================================
# SEÇÃO 3: PREPARAR DIRETÓRIOS
# ============================================================================
# Cria a estrutura de diretórios para o site
# ============================================================================

- name: Criar diretório raiz do site
  file:
    path: "{{ web_root }}"
    state: directory
    owner: "{{ nginx_user }}"
    group: "{{ nginx_group }}"
    mode: '0755'
  tags:
    - nginx
    - directories

- name: Criar diretório de logs
  file:
    path: "/var/log/nginx"
    state: directory
    owner: "{{ nginx_user }}"
    group: "{{ nginx_group }}"
    mode: '0755'
  tags:
    - nginx
    - directories

# ============================================================================
# SEÇÃO 4: COPIAR ARQUIVOS DO SITE
# ============================================================================
# Copia os arquivos do site para o diretório raiz
# ============================================================================

- name: Ajustar permissoes do diretorio para copia
  file:
    path: "{{ web_root }}"
    owner: ubuntu
    group: ubuntu
    mode: '0755'
  tags:
    - nginx
    - files

- name: Copiar arquivos do site recursivamente
  synchronize:
    src: "../../site/"
    dest: "{{ web_root }}/"
    archive: yes
    delete: no
    private_key: "../../ifmt-devops-iac.pem"
  delegate_to: localhost
  become: no
  tags:
    - nginx
    - files

- name: Ajustar permissoes dos arquivos do site
  file:
    path: "{{ web_root }}"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_group }}"
    mode: '0755'
    recurse: yes
  tags:
    - nginx
    - files

# ============================================================================
# SEÇÃO 5: DESATIVAR SITE PADRÃO
# ============================================================================
# Remove o link simbólico do site padrão
# ============================================================================

- name: Desativar site padrão do Nginx
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: restart nginx
  tags:
    - nginx
    - config

# ============================================================================
# SEÇÃO 6: CRIAR CONFIGURAÇÃO DO NGINX
# ============================================================================
# Cria a configuração do Nginx usando um template Jinja2
# ============================================================================

- name: Criar configuração do Nginx para o domínio
  template:
    src: nginx.conf.j2
    dest: "/etc/nginx/sites-available/{{ domain_name }}"
    owner: root
    group: root
    mode: '0644'
  notify: restart nginx
  tags:
    - nginx
    - config

# ============================================================================
# SEÇÃO 7: ATIVAR SITE
# ============================================================================
# Cria o link simbólico para ativar o site
# ============================================================================

- name: Ativar site
  file:
    src: "/etc/nginx/sites-available/{{ domain_name }}"
    dest: "/etc/nginx/sites-enabled/{{ domain_name }}"
    state: link
  notify: restart nginx
  tags:
    - nginx
    - config

# ============================================================================
# SEÇÃO 8: VALIDAR CONFIGURAÇÃO DO NGINX
# ============================================================================
# Testa a sintaxe da configuração antes de reiniciar
# ============================================================================

- name: Validar configuração do Nginx
  command: nginx -t
  register: nginx_test
  changed_when: false
  tags:
    - nginx
    - validate

- name: Exibir resultado da validação
  debug:
    var: nginx_test.stdout_lines
  tags:
    - nginx
    - validate